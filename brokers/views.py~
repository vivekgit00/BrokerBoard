from .models import DeltaBroker
from rest_framework import viewsets
from .serializer import DeltaBrokerSerializer
from rest_framework.decorators import action
from brokers.utils import custom_response, email_password, send_otp_email
from django.utils.crypto import get_random_string
import  random, string
import logging

logger = logging.getLogger('custom')

# Create your views here.

class DeltaBrokerView(viewsets.ModelViewSet):
    queryset = DeltaBroker.objects.all()
    serializer_class = DeltaBrokerSerializer

    @action(methods=['post'], detail=False, url_path='select_broker')
    def select_broker(self, request):
        data = request.data
        email = request.data.get('email')
        phone = request.data.get('phone_number')
        logger.info(f"Broker selection attempt: email={email}",extra={'email': email})
        client_id = request.data.get('client_id')
        if DeltaBroker.objects.filter(email=email).exists() and DeltaBroker.objects.filter(phone_number=phone).exists():
            logger.error(f"Email or phone number already exists ", extra={'email': email})
            return custom_response(message="email or phone_number already exists", status=0)
        if DeltaBroker.objects.filter(client_id=client_id).exists():
            return custom_response(message="client_id already exists", status=0)

        generated_password = ''.join(random.choices(string.ascii_letters + string.digits, k=16))
        print(generated_password)

        serializer = DeltaBrokerSerializer(data=request.data)
        print(serializer)
        if serializer.is_valid():
            serializer.save(password=generated_password)
            email_password(data.get("broker"), generated_password, email)
            logger.info(f"New broker registered: email={email}, client_id={client_id}", extra={'request': request})
            return  custom_response(message="ok", status=1, data=serializer.data)
        return custom_response(message="not_ok", status=0, data=serializer.errors)

    @action(methods=['post'], detail=False, url_path='login')
    def login(self, request):
        email = request.data.get('email')
        password = request.data.get('password')
        if not DeltaBroker.objects.filter(email=email).exists():
            return custom_response(message="email not exists", status=0)
        if not DeltaBroker.objects.filter(password=password).exists():
            return custom_response(message="password not exists", status=0)
        serializer = DeltaBrokerSerializer(DeltaBroker.objects.get(email=email))
        logger.info(f"Login attempt Successful: email={email}", extra={'email': email})
        return custom_response(message="Login Successful", status=1)

    @action(methods=['post'], detail=False, url_path='change_password')
    def change_password(self, request):
        email = request.data.get('email')
        password = request.data.get('password')
        new_password = request.data.get('new_password')
        if not DeltaBroker.objects.filter(email=email).exists():
            logger.error(f"email not exists: email={email}", extra={'email': email})
            return custom_response(message="email not exists", status=0)
        if not DeltaBroker.objects.filter(password=password).exists():
            logger.error(f"password not match: email={email}", extra={'email': email}  )
            return custom_response(message="password not exists", status=0)
        DeltaBroker.objects.filter(email=email).update(password=new_password)
        logger.info(f"Password Changed Successfully: email={email}", extra={'email': email})
        return custom_response(message="Password Changed Successfully", status=1)

    @action(methods=['post'], detail=False, url_path='otp_verify')  # For Account Update Verification
    def otp_verify(self, request):
        email = request.data.get('email')
        otp = request.data.get('otp')
        if not DeltaBroker.objects.filter(email=email).exists():
            return custom_response(message="email not exists", status=0)
        if not DeltaBroker.objects.filter(otp_code=otp).exists():
            logger.error("Incorrect OTP", extra={'email': email})
            return custom_response(message="Incorrect OTP", status=0)
        DeltaBroker.objects.filter(email=email).update(otp_verified=True)
        logger.info(f"OTP Verified Successfully: email={email}", extra={'email': email})
        return custom_response(message="OTP Verified Successfully", status=1)

    @action(methods=['post'], detail=False, url_path='send_otp')
    def send_otp_email(self, request):
        email = request.data.get('email')
        if not DeltaBroker.objects.filter(email=email).exists():
            return custom_response(message="email not exists", status=0)
        otp = get_random_string(length=6, allowed_chars='0123456789')
        print("email otp account update --->>>>>", otp)
        send_otp_email(email, otp)
        logger.info(f"OTP Sent Successfully: email={email}", extra={'email': email})
        DeltaBroker.objects.filter(email=email).update(otp_code=otp)
        return custom_response(message="OTP Sent Successfully", status=1)

    @action(methods=['post'], detail=False, url_path='update_profile')
    def update_profile(self, request):
        email = request.data.get('email')
        print(DeltaBroker.otp_verified)
        if DeltaBroker.otp_verified:
            if not DeltaBroker.objects.filter(email=email).exists():
                return custom_response(message="email not exists", status=0)
            serializer = DeltaBrokerSerializer(DeltaBroker.objects.get(email=email), data=request.data, partial=True)
            if serializer.is_valid():
                serializer.save()
                logger.info(f"Profile Updated Successfully: email={email}", extra={'email': email})
                return custom_response(message="Profile Updated Successfully", status=1, data=serializer.data)
            return custom_response(message="Profile Not Updated", status=0)
        else:
            logger.error("OTP Not Verified", extra={'email': email})
            return custom_response(message="OTP Not Verified", status=0)

